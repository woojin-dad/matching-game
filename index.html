<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ìš°ì§„ì´ì˜ ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        html, body { overscroll-behavior-y: contain; }
        body { background: #FEE500; font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; overflow-y: auto; }
        .container { width: 96%; max-width: 700px; background: white; padding: 12px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); position: relative; display: flex; flex-direction: column; margin: 20px 0; height: auto; min-height: auto; }
        #statusBar { position: sticky; top: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #f9fafb; padding: 8px 12px; border-radius: 15px; flex-shrink: 0; height: 54px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-left { display: flex; align-items: center; gap: 6px; }
        .coin-box { font-weight: 900; color: #3C1E1E; font-size: 1rem; display: flex; align-items: center; gap: 3px; }
        .music-toggle-btn { background: #E5E7EB; border: none; padding: 4px 10px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; box-shadow: 0 2px 0 #9CA3AF; }
        .home-btn { position: absolute; left: 50%; transform: translateX(-50%); background: #3C1E1E; color: white; padding: 6px 18px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #000; }
        .status-right { display: flex; align-items: center; gap: 5px; }
        .gauge-bg { width: 90px; height: 16px; background: #e5e7eb; border-radius: 10px; overflow: hidden; border: 1px solid #d1d5db; } 
        #gaugeFill { height: 100%; width: 0%; background: linear-gradient(90deg, #4ADE80, #16A34A); transition: width 0.4s ease-out; }
        .reward-box { font-weight: 900; color: #3C1E1E; font-size: 1.1rem; }
        #mainPage { flex: 1; padding: 10px 5px; }
        .main-title { font-size: 2.2rem; font-weight: 900; color: #3C1E1E; text-shadow: 1px 1px 0 #fff; letter-spacing: -0.05em; cursor: pointer; -webkit-user-select: none; user-select: none; }
        .category-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 18px; margin-top: 20px; color: #374151; border-left: 6px solid; padding-left: 12px; }
        .mode-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 16px; padding-bottom: 40px; justify-content: center; justify-items: center; }
        .mode-card { position: relative; background: #3C1E1E; color: #FEE500; width: 100%; max-width: 160px; border-radius: 26px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 8px 0 #1a0d0d; padding: 16px 10px; text-align: center; -webkit-user-select: none; user-select: none; touch-action: manipulation; min-height: 240px; height: auto; }
        .mode-card:active { transform: translateY(4px); box-shadow: 0 4px 0 #1a0d0d; }
        .mode-card.locked { background: #94a3b8 !important; box-shadow: 0 8px 0 #64748b !important; opacity: 0.8; filter: grayscale(1); }
        .mode-card .icon-area { font-size: 2.8rem; margin-bottom: 6px; line-height: 1; }
        .mode-card .title { font-size: 1.15rem; font-weight: 900; margin-top: 4px; margin-bottom: 8px; line-height: 1.2; color: #FFFFFF; word-break: keep-all; }
        .info-badge { font-size: 1rem; font-weight: 700; background: rgba(0,0,0,0.4); color: #FEE500; padding: 4px 8px; border-radius: 10px; margin-top: 4px; width: 95%; white-space: nowrap; overflow: hidden; }
        .delete-btn { position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: #EF4444; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2.5px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 50; }
        body.admin-mode .delete-btn { display: flex !important; }
        #gamePage { flex: 1; display: none; flex-direction: column; justify-content: flex-start; padding-bottom: 5px; }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 8px; flex-shrink: 0; }
        #gameTitle { font-size: 1.1rem; font-weight: 900; color: #3C1E1E; }
        #pageIndicator { font-size: 0.85rem; font-weight: 900; background: #3C1E1E; color: #FEE500; padding: 4px 14px; border-radius: 50px; }
        .card { padding: 4px 8px; border-radius: 12px; border: 2.5px solid #e5e7eb; text-align: center; cursor: pointer; font-weight: 900; background: white; display: flex; align-items: center; justify-content: center; height: clamp(55px, 8.5vh, 90px); width: 100%; box-shadow: 0 4px 0 #f3f4f6; transition: all 0.05s linear; line-height: 1.1; }
        .term-card { background: #3C1E1E; color: #FEE500; border-color: #3C1E1E; box-shadow: 0 4px 0 #1a0d0d; }
        #definitionsColumn .card { border-color: #d1d5db; color: #3C1E1E; box-shadow: 0 4px 0 #cbd5e1; }
        .selected { border-color: #FEE500 !important; z-index: 10; transform: translateY(-2px); box-shadow: 0 4px 0 #FEE500 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        .wrong-impact { animation: shake 0.2s ease-in-out; border-color: #EF4444 !important; background: #FEF2F2 !important; box-shadow: 0 4px 0 #EF4444 !important; }
        .matched { pointer-events: none; border-color: #FACC15 !important; background: #FEF9C3 !important; opacity: 0.5; transition: all 0.1s; }
        #resetPopup { position: fixed; top: 20px; right: -350px; width: 280px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); border: 3px solid #EF4444; padding: 20px; z-index: 2000; transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); text-align: center; }
        #resetPopup.show { right: 20px; }
        #resetPopup.success-mode { border-color: #4ADE80; }
        #resetPopup p { font-weight: 900; color: #3C1E1E; margin-bottom: 15px; font-size: 1rem; line-height: 1.4; white-space: pre-line; }
        .popup-btns { display: flex; gap: 8px; justify-content: center; }
        .popup-btns button { padding: 8px 18px; border-radius: 12px; font-weight: 900; font-size: 0.9rem; cursor: pointer; border: none; }
        .btn-confirm { background: #EF4444; color: white; }
        .btn-cancel { background: #E5E7EB; color: #4B5563; }
        #rewardModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; text-align: center; border: 6px solid #4ADE80; width: 85%; max-width: 400px; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body>
<div id="resetPopup"><p id="popupText"></p><div class="popup-btns" id="popupBtnArea"><button class="btn-confirm" id="btnOk">í™•ì¸</button><button class="btn-cancel" onclick="closeResetPopup()">ì·¨ì†Œ</button></div></div>
<div id="rewardModal"><h2 id="rewardTitle">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2><p id="rewardModalText"></p><button id="rewardBtn" onclick="closeRewardModal()" style="background: #4ADE80; color: white; padding: 10px 40px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 4px 0 #16A34A;">í™•ì¸</button></div>
<div class="container">
    <audio id="bgm"></audio> <div id="statusBar">
        <div class="status-left"><div class="coin-box">ğŸª™ <span id="coinCount">...</span></div><button id="topMusicBtn" class="music-toggle-btn" onclick="toggleBGM()"><span id="musicIcon">ğŸµ</span></button></div>
        <button id="topHomeBtn" onclick="goToMain()" class="home-btn" style="visibility: hidden;">ğŸ  í™ˆ</button>
        <div class="status-right"><span class="bolt-icon">âš¡</span><div class="gauge-bg"><div id="gaugeFill"></div></div><div class="reward-box">ğŸ <span id="giftCount">0</span></div></div>
    </div>
    <div id="mainPage">
        <h1 class="text-center my-6 flex items-center justify-center gap-4"><span class="main-title" onclick="triggerAdminMode()">ğŸ§© ìš°ì§„ì´ì˜ ë§¤ì¹­ ê²Œì„<span id="adminMark" style="display:none; font-size:1rem; vertical-align:middle;"> ğŸ› ï¸</span></span></h1>
        <div class="category-container mb-8"><div class="category-title text-blue-600 border-blue-600">ğŸ”„ ë³µìŠµ</div><div id="reviewGrid" class="mode-grid"></div></div>
        <div class="category-container mb-8"><div class="category-title text-green-600 border-green-600">ğŸ“– í•™ìŠµ</div><div id="studyGrid" class="mode-grid"></div></div>
    </div>
    <div id="gamePage">
        <div class="game-header"><h2 id="gameTitle"></h2><div id="pageIndicator"></div></div>
        <div class="game-board-wrapper"><div class="grid grid-cols-2 gap-x-2 gap-y-2.5 w-full" id="gameGrid"><div id="termsColumn" class="flex flex-col gap-y-2.5"></div><div id="definitionsColumn" class="flex flex-col gap-y-2.5"></div></div></div>
    </div>
</div>

<script>
    // ğŸ›¡ï¸ ìš°ì§„ì´ì˜ 'ë‹¤ì¤‘ íƒ­ ê¼¼ìˆ˜' ë°©ì§€ ì‹œìŠ¤í…œ (ì´ë¦„í‘œ ë°©ì‹)
    const GAME_ID = "woojin_game_active";

    // 1. ì´ë¯¸ ì´ë¦„í‘œê°€ ìˆëŠ”ì§€ í™•ì¸
    if (localStorage.getItem(GAME_ID) === 'true') {
        // ì•„ë¹  ì „ìš© ë§ˆìŠ¤í„°í‚¤: 'í™•ì¸' ëˆ„ë¥´ë©´ ì…ì¥, 'ì·¨ì†Œ' ëˆ„ë¥´ë©´ ì°¨ë‹¨
        const retry = confirm("ì´ë¯¸ ê²Œì„ì´ ì—´ë ¤ ìˆë‚˜ìš”? ì•„ë‹ˆë¼ë©´ 'í™•ì¸'ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        if (retry) {
            localStorage.removeItem(GAME_ID);
            location.reload();
        } else {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>ì°½ì„ í•˜ë‚˜ë§Œ ì—´ì–´ì£¼ì„¸ìš”!</h1>";
            throw new Error("ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€");
        }
    }

    // 2. ì²˜ìŒ ë“¤ì–´ì™”ìœ¼ë©´ ì´ë¦„í‘œ ë¶™ì´ê¸°
    localStorage.setItem(GAME_ID, 'true');

    // 3. ì°½ì„ ë‹«ì„ ë•Œ ì´ë¦„í‘œ ë–¼ê¸°
    window.onunload = function() {
        localStorage.removeItem(GAME_ID);
    };

    // --- ì—¬ê¸°ì„œë¶€í„°ëŠ” ì›ë˜ ìˆë˜ ì•„ë²„ë‹˜ì˜ ì½”ë“œë“¤ ---
    const finalScriptUrl = "https://script.google.com/macros/s/AKfycbyWobZtNiP8eFtdxTzk9ZXCOfaIyEZKN_hlAsjMggj6OEM-PXbn7g_YG6y1EJhcWa0Fyg/exec";
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3vqts3wY7dCnxbXq1pedePNTOH32_sNnxqAgqx4EIYtaTok3NU-HpwdYOaNIdWFvogYEd6JI1pst1/pub?output=csv";

    // ğŸµ ìŒì•… ì„¤ì •
    const mySongs = [
        "https://woojin-dad.github.io/matching-game/bgm/about_that_oldie.mp3",
"https://woojin-dad.github.io/matching-game/bgm/after_school_jamboree.mp3",
"https://woojin-dad.github.io/matching-game/bgm/put_on_your_dancing_pants.mp3",
"https://woojin-dad.github.io/matching-game/bgm/arc_of_the_sun.mp3",
"https://woojin-dad.github.io/matching-game/bgm/blue_ribbons.mp3",
"https://woojin-dad.github.io/matching-game/bgm/broccoli_on_my_plate.mp3",
"https://woojin-dad.github.io/matching-game/bgm/bubinga.mp3",
"https://woojin-dad.github.io/matching-game/bgm/bunny_hop.mp3",
"https://woojin-dad.github.io/matching-game/bgm/city_blocks.mp3",
"https://woojin-dad.github.io/matching-game/bgm/claudio_the_worm.mp3",
"https://woojin-dad.github.io/matching-game/bgm/coffee_stains.mp3",
"https://woojin-dad.github.io/matching-game/bgm/crystal.mp3",
"https://woojin-dad.github.io/matching-game/bgm/ex_boxer.mp3",
"https://woojin-dad.github.io/matching-game/bgm/fantasyland.mp3",
"https://woojin-dad.github.io/matching-game/bgm/full_speed_ahead.mp3",
"https://woojin-dad.github.io/matching-game/bgm/get_outside.mp3",
"https://woojin-dad.github.io/matching-game/bgm/girasol.mp3",
"https://woojin-dad.github.io/matching-game/bgm/happy_mistake.mp3",
"https://woojin-dad.github.io/matching-game/bgm/how_about_it.mp3",
"https://woojin-dad.github.io/matching-game/bgm/if_i_had_a_chicken.mp3",
"https://woojin-dad.github.io/matching-game/bgm/jigsaw_puzzle.mp3",
"https://woojin-dad.github.io/matching-game/bgm/kazoom.mp3",
"https://woojin-dad.github.io/matching-game/bgm/lovable_clown_sit_com.mp3",
"https://woojin-dad.github.io/matching-game/bgm/mr._sunny_face.mp3",
"https://woojin-dad.github.io/matching-game/bgm/mr._turtle.mp3",
"https://woojin-dad.github.io/matching-game/bgm/nimbus.mp3",
"https://woojin-dad.github.io/matching-game/bgm/payday.mp3",
"https://woojin-dad.github.io/matching-game/bgm/payday2.mp3",
"https://woojin-dad.github.io/matching-game/bgm/rainbow_forest.mp3",
"https://woojin-dad.github.io/matching-game/bgm/rainy_day_games.mp3",
"https://woojin-dad.github.io/matching-game/bgm/sand_castles.mp3",
"https://woojin-dad.github.io/matching-game/bgm/snack_time.mp3",
"https://woojin-dad.github.io/matching-game/bgm/splashing_around.mp3",
"https://woojin-dad.github.io/matching-game/bgm/upbeat.mp3",
"https://woojin-dad.github.io/matching-game/bgm/venice_beach.mp3"
    ];

    let state = { coins: 0, totalMatchedCount: 0, giftCount: 0, maxGauge: 500, selectedTerm: null, selectedDef: null, isPerfect: true };
    let gameData = [], currentPage = 0, allCurrentItems = [], pagePairs = [];
    let wrongDB = JSON.parse(localStorage.getItem('woojin_wrong_v3')) || {};
    let doneDB = JSON.parse(localStorage.getItem('woojin_done_v1')) || {};
    let perfectDB = JSON.parse(localStorage.getItem('woojin_perfect_v1')) || {};
    let dailyLimitDB = JSON.parse(localStorage.getItem('woojin_daily_limit_v3')) || { date: "", counts: {} };
    let tryDB = JSON.parse(localStorage.getItem('woojin_try_v1')) || {};
    let currentActiveTitle = "";
    let lastTime = 0;

    const todayStr = new Date().toLocaleDateString();
    if (dailyLimitDB.date !== todayStr) { dailyLimitDB = { date: todayStr, counts: {} }; localStorage.setItem('woojin_daily_limit_v3', JSON.stringify(dailyLimitDB)); }

    const bgm = document.getElementById('bgm');
    bgm.ontimeupdate = function() {
    if (!bgm.seeking) { 
        lastTime = bgm.currentTime; 
    }
};

bgm.onseeking = function() {
    if (Math.abs(bgm.currentTime - lastTime) > 1) { 
        bgm.currentTime = lastTime;
        bgm.play();
    }
};
    // ğŸ’¡ ë…¸ë˜ê°€ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ëœë¤ ê³¡ ì¬ìƒ (onended ì¶”ê°€)
    bgm.onended = function() { setRandomBGM(); };

    function setRandomBGM() {
        const randomURL = mySongs[Math.floor(Math.random() * mySongs.length)];
        bgm.src = randomURL; bgm.load(); bgm.volume = 0.3;
        // ìŒì•…ì´ ì¼œì ¸ìˆëŠ” ìƒíƒœ(ğŸµ)ë¼ë©´ ì¦‰ì‹œ ì¬ìƒ
        if (document.getElementById('musicIcon').innerText === 'ğŸµ') {
            bgm.play().catch(e => console.log("ìë™ì¬ìƒ ëŒ€ê¸°"));
        }
    }

    // ğŸ’¡ ìŒì•… ë²„íŠ¼: ë‹¨ìˆœíˆ ì†Œë¦¬ë§Œ ë„ê³  ì¼œê¸° (ì´ì–´ ë“£ê¸°)
    function toggleBGM() {
        if (!bgm.src) { setRandomBGM(); return; }
        if (bgm.paused) {
            
            bgm.play()
               .then(() => { document.getElementById('musicIcon').innerText = 'ğŸµ'; })
               .catch(e => console.log("í„°ì¹˜ í•„ìš”"));
        } else {
            bgm.pause();
            document.getElementById('musicIcon').innerText = 'ğŸ”‡';
        }
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if (type === 'click') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'correct') { osc.type = 'triangle'; osc.frequency.setValueAtTime(523.25, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.2); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
        else if (type === 'wrong') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
        else if (type === 'tick') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.05); osc.start(now); osc.stop(now + 0.05); } 
        else if (type === 'master') { const notes = [523.25, 659.25, 783.99, 1046.50]; notes.forEach((freq, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sine'; o.frequency.setValueAtTime(freq, now + i * 0.1); g.gain.setValueAtTime(0.5, now + i * 0.1); g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.4); o.start(now + i * 0.1); o.stop(now + i * 0.1 + 0.4); }); }
    }

    function animateCoinIncrease(targetAmount) { let added = 0; const startValue = state.coins - targetAmount; const step = Math.ceil(targetAmount / 20); const timer = setInterval(() => { added += step; if (added >= targetAmount) { document.getElementById('coinCount').innerText = state.coins.toLocaleString(); clearInterval(timer); } else { document.getElementById('coinCount').innerText = (startValue + added).toLocaleString(); playSound('tick'); } }, 50); }
    async function syncFromCloud() { try { const response = await fetch(finalScriptUrl); const data = await response.json(); state.coins = Number(data.coins) || 0; state.totalMatchedCount = Number(data.matched) || 0; state.giftCount = Number(data.gifts) || 0; state.maxGauge = Number(data.maxGauge) || 500; updateUI(false); } catch (e) {} }
    async function syncToCloud() { try { if (state.totalMatchedCount >= state.maxGauge) { state.giftCount += 1; state.coins += 1000; state.totalMatchedCount = 0; document.getElementById('giftCount').innerText = state.giftCount; document.getElementById('gaugeFill').style.width = '0%'; animateCoinIncrease(1000); playSound('master'); confetti({ particleCount: 250, spread: 80, origin: { y: 0.6 } }); showToast("âœ¨ ìš°ì§„ì•„ ëŒ€ë‹¨í•´! ì„ ë¬¼ 1ê°œì™€ 1000ì½”ì¸ íšë“!!", "success"); } await fetch(finalScriptUrl, { method: 'POST', body: JSON.stringify({ coins: state.coins, matched: state.totalMatchedCount, gifts: state.giftCount }) }); } catch (e) {} }
    function updateUI(send = true) { document.getElementById('coinCount').innerText = state.coins.toLocaleString(); document.getElementById('giftCount').innerText = state.giftCount; const progress = (state.totalMatchedCount / state.maxGauge) * 100; document.getElementById('gaugeFill').style.width = Math.min(progress, 100) + '%'; if(send) syncToCloud(); }
    function triggerAdminMode() { if (!window.clickCount) window.clickCount = 0; window.clickCount++; clearTimeout(window.clickTimer); window.clickTimer = setTimeout(() => { window.clickCount = 0; }, 2000); if (window.clickCount === 5) { const isAdmin = document.body.classList.toggle('admin-mode'); document.getElementById('adminMark').style.display = isAdmin ? 'inline' : 'none'; showToast(isAdmin ? "ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”" : "ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ í•´ì œ", 'success'); window.clickCount = 0; } }
    function showToast(message, type = 'info') { const popup = document.getElementById('resetPopup'); const text = document.getElementById('popupText'); const btnArea = document.getElementById('popupBtnArea'); if (popup.classList.contains('show') && (type === 'success' || type === 'info')) { text.innerText += "\n\n" + message; } else { text.innerText = message; } if (type === 'success' || type === 'info') { btnArea.style.display = 'none'; popup.classList.toggle('success-mode', type === 'success'); popup.classList.add('show'); clearTimeout(window.autoCloseTimer); window.autoCloseTimer = setTimeout(() => closeResetPopup(), 7000); } else { btnArea.style.display = 'flex'; popup.classList.remove('success-mode'); popup.classList.add('show'); } }
    function closeResetPopup() { document.getElementById('resetPopup').classList.remove('show'); }
    function openResetPopup(e, title, type) { if(e) { e.preventDefault(); e.stopPropagation(); } const modeName = (type === 'study' ? 'í•™ìŠµ' : 'ë³µìŠµ'); const cleanName = title.trim(); showToast(`âš ï¸ ${cleanName}ì˜\n${modeName} ê¸°ë¡ì„ ì§€ìš¸ê¹Œìš”?`, 'confirm'); document.getElementById('btnOk').onclick = () => { const sKey = cleanName + "_study", rKey = cleanName + "_review"; if (type === 'study') { delete doneDB[sKey]; delete perfectDB[sKey]; delete dailyLimitDB.counts[sKey]; } else { delete doneDB[rKey]; delete wrongDB[cleanName]; delete perfectDB[rKey]; delete tryDB[cleanName]; delete dailyLimitDB.counts[rKey]; } localStorage.setItem('woojin_done_v1', JSON.stringify(doneDB)); localStorage.setItem('woojin_wrong_v3', JSON.stringify(wrongDB)); localStorage.setItem('woojin_perfect_v1', JSON.stringify(perfectDB)); localStorage.setItem('woojin_try_v1', JSON.stringify(tryDB)); localStorage.setItem('woojin_daily_limit_v3', JSON.stringify(dailyLimitDB)); closeResetPopup(); renderMenu(); }; }
    function parseCSV(text) { return text.split('\n').map(row => { let cols = []; let current = ""; let inQuotes = false; for (let i = 0; i < row.length; i++) { if (row[i] === '"') inQuotes = !inQuotes; else if (row[i] === ',' && !inQuotes) { cols.push(current); current = ""; } else current += row[i]; } cols.push(current); return cols; }); }
    function applySmartFontSize(el) { let size = 1.35; el.style.fontSize = size + "rem"; while (el.scrollHeight > el.clientHeight && size > 1.0) { size -= 0.05; el.style.fontSize = size + "rem"; } }
    async function fetchSheetData() { await syncFromCloud(); try { const res = await fetch(`${sheetUrl}&cb=${Date.now()}`); const text = await res.text(); const rows = parseCSV(text).slice(1); gameData = rows.map(row => { if (!row[0] || !row[2]) return null; const rawData = row[2].trim().endsWith(';') ? row[2] : row[2] + ';'; const items = rawData.split(';').map(i => { const p = i.split('/'); return p.length >= 2 ? { t: p[0].trim(), d: p[1].trim() } : null; }).filter(i => i); return items.length > 0 ? { title: row[0].trim(), icon: (row[1] || "ğŸ“š").trim(), items } : null; }).filter(d => d); renderMenu(); } catch (e) { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!"); } }

    function smartSort(array, modePrefix) { 
        return array.sort((a, b) => { 
            const cleanA = a.title.trim(); const cleanB = b.title.trim();
            const nameA = cleanA + modePrefix, nameB = cleanB + modePrefix; 
            const dateA = doneDB[nameA], dateB = doneDB[nameB]; 
            if (modePrefix === "_review") {
                const countA = (wrongDB[cleanA] || []).length; const countB = (wrongDB[cleanB] || []).length;
                if (countA > 0 && countB === 0) return -1;
                if (countA === 0 && countB > 0) return 1;
                if (countA > 0 && countB > 0) {
                    if (!dateA && dateB) return -1;
                    if (dateA && !dateB) return 1;
                    if (dateA && dateB) { if (dateA < dateB) return -1; if (dateA > dateB) return 1; }
                }
                return 0;
            }
            if (!dateA && dateB) return -1; if (dateA && !dateB) return 1;
            if (dateA < dateB) return -1; if (dateA > dateB) return 1;
            return 0;
        }); 
    }

    function renderMenu() {
        const studyGrid = document.getElementById('studyGrid'), reviewGrid = document.getElementById('reviewGrid');
        studyGrid.innerHTML = ''; reviewGrid.innerHTML = '';
        smartSort([...gameData], "_study").forEach((mode) => { 
            const cleanName = mode.title.trim(); const sKey = cleanName + "_study", isLocked = (dailyLimitDB.counts[sKey] || 0) >= 1; 
            const d = document.createElement('div'); d.className = 'mode-card' + (isLocked ? ' locked' : ''); 
            d.innerHTML = `<div class="delete-btn" onclick="event.stopPropagation(); openResetPopup(event, '${cleanName}', 'study')">Ã—</div><div class="icon-area">${mode.icon}</div><div class="title">${cleanName}</div><div class="info-badge">ğŸ“‹ ${mode.items.length}ìŒ</div>${doneDB[sKey] ? `<div class="info-badge">ğŸ“… ${doneDB[sKey]}</div>` : ''}`; 
            d.onclick = () => { 
                if (isLocked) { showToast("ë‚´ì¼ ë˜ ë§Œë‚˜ìš”! ğŸ˜Š\nì˜¤ëŠ˜ ê³µë¶€ëŠ” ì¶©ë¶„íˆ ì˜í–ˆì–´ìš”! ìµœê³ !", 'success'); return; } 
                state.isPerfect = true; currentActiveTitle = cleanName; 
                
                // ğŸ’¡ [ìŒì•… ìë™ ì‹œì‘] ê³¼ëª© í´ë¦­ ì‹œ ìŒì•…ì´ êº¼ì ¸ìˆë‹¤ë©´ ì¬ìƒ ì‹œì‘
                if (!bgm.src) { setRandomBGM(); }
                if (bgm.paused && document.getElementById('musicIcon').innerText === 'ğŸµ') {
                    bgm.play().catch(e => console.log("í„°ì¹˜ í›„ ì¬ìƒ"));
                }

                startGame(cleanName, mode.items, false); 
            }; 
            studyGrid.appendChild(d); 
        });
        smartSort([...gameData], "_review").forEach((mode) => { 
            const cleanName = mode.title.trim(); const rKey = cleanName + "_review", rItems = wrongDB[cleanName] || [], isLocked = (dailyLimitDB.counts[rKey] || 0) >= 2; 
            const r = document.createElement('div'); r.className = 'mode-card' + (isLocked ? ' locked' : ''); 
            r.style.background = isLocked ? "#94a3b8" : "#475569"; 
            const tryCount = tryDB[cleanName] || 0;
            const perfectCount = perfectDB[rKey] || 0;
            const lastDate = doneDB[rKey] || "ë¯¸ì™„ë£Œ";
            r.innerHTML = `
                <div class="delete-btn" onclick="event.stopPropagation(); openResetPopup(event, '${cleanName}', 'review')">Ã—</div>
                <div class="icon-area">${mode.icon}</div>
                <div class="title">${cleanName}</div>
                <div class="info-badge">ğŸ“‹ ${rItems.length}ìŒ</div>
                <div class="info-badge">ğŸ¥‡ ${perfectCount} / 5íšŒ</div>
                <div class="info-badge">ğŸš€ ë„ì „: ${tryCount}íšŒ</div>
                <div class="info-badge">ğŸ“… ${lastDate}</div>
            `; 
            r.onclick = () => { 
                if (isLocked) { showToast("ë‚´ì¼ ë˜ ë§Œë‚˜ìš”! ğŸ˜Š\nì˜¤ëŠ˜ ê³µë¶€ëŠ” ì¶©ë¶„íˆ ì˜í–ˆì–´ìš”! ìµœê³ !", 'success'); return; } 
                state.isPerfect = true; currentActiveTitle = cleanName; 

                // ğŸ’¡ [ìŒì•… ìë™ ì‹œì‘] ê³¼ëª© í´ë¦­ ì‹œ ìŒì•…ì´ êº¼ì ¸ìˆë‹¤ë©´ ì¬ìƒ ì‹œì‘
                if (!bgm.src) { setRandomBGM(); }
                if (bgm.paused && document.getElementById('musicIcon').innerText === 'ğŸµ') {
                    bgm.play().catch(e => console.log("í„°ì¹˜ í›„ ì¬ìƒ"));
                }

                if(rItems.length > 0) startGame(cleanName, rItems, true); 
                else showToast("ìš°ì™€! ì™„ë²½í•´ìš”! âœ¨\nì§€ê¸ˆì€ ë³µìŠµí•  ë‹¨ì–´ê°€ í•˜ë‚˜ë„ ì—†ì–´ìš”!", 'success'); 
            }; 
            reviewGrid.appendChild(r); 
        });
    }

    function startGame(title, items, isReview) { window.isReviewMode = isReview; document.getElementById('mainPage').style.display = 'none'; document.getElementById('gamePage').style.display = 'flex'; document.getElementById('topHomeBtn').style.visibility = 'visible'; const sortedItems = [...items].sort(() => Math.random() - 0.5), distributed = []; let pool = [...sortedItems]; while(pool.length > 0) { const page = [], pageTerms = new Set(), pageDefs = new Set(), nextPool = []; for (const item of pool) { if (page.length < 10 && !pageTerms.has(item.t) && !pageDefs.has(item.d)) { page.push(item); pageTerms.add(item.t); pageDefs.add(item.d); } else { nextPool.push(item); } } if (page.length === 0 && nextPool.length > 0) page.push(nextPool.shift()); distributed.push(...page); pool = nextPool; } allCurrentItems = distributed; currentPage = 0; renderPage(title); window.scrollTo(0, 0); }
    function renderPage(title) { const totalPages = Math.ceil(allCurrentItems.length / 10); document.getElementById('gameTitle').innerText = (window.isReviewMode ? "ğŸ”„ " : "") + title; document.getElementById('pageIndicator').innerText = `${currentPage + 1} / ${totalPages}`; pagePairs = allCurrentItems.slice(currentPage * 10, (currentPage + 1) * 10); const tCol = document.getElementById('termsColumn'), dCol = document.getElementById('definitionsColumn'); tCol.innerHTML = ''; dCol.innerHTML = ''; [...pagePairs].sort(() => Math.random() - 0.5).forEach(item => { const c = document.createElement('div'); c.className = 'card term-card'; c.innerText = item.t; tCol.appendChild(c); applySmartFontSize(c); c.onclick = () => selectCard(item, 'term', c); }); [...pagePairs].sort(() => Math.random() - 0.5).forEach(item => { const c = document.createElement('div'); c.className = 'card'; c.innerText = item.d; dCol.appendChild(c); applySmartFontSize(c); c.onclick = () => selectCard(item, 'def', c); }); }

    function selectCard(item, type, el) {
        if(el.classList.contains('matched') || el.classList.contains('wrong-impact')) return;
        playSound('click');
        if(type === 'term') { if(state.selectedTerm && state.selectedTerm.el === el) { el.classList.remove('selected'); state.selectedTerm = null; return; } document.querySelectorAll('#termsColumn .card').forEach(c => c.classList.remove('selected')); state.selectedTerm = { item, el }; }
        else { if(state.selectedDef && state.selectedDef.el === el) { el.classList.remove('selected'); state.selectedDef = null; return; } document.querySelectorAll('#definitionsColumn .card').forEach(c => c.classList.remove('selected')); state.selectedDef = { item, el }; }
        el.classList.add('selected');
        if(state.selectedTerm && state.selectedDef) {
            const t = state.selectedTerm, d = state.selectedDef;
            if(t.item.t === d.item.t || t.item.d === d.item.d) {
                playSound('correct'); t.el.className = 'card matched'; d.el.className = 'card matched'; state.coins++; state.totalMatchedCount++; updateUI(); state.selectedTerm = state.selectedDef = null;
                if(document.querySelectorAll('.matched').length === (pagePairs.length * 2)) {
                    if((currentPage + 1) * 10 < allCurrentItems.length) { currentPage++; setTimeout(() => renderPage(currentActiveTitle), 500); }
                    else {
                        const now = new Date(), dateStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}`;
                        const cleanName = currentActiveTitle; 
                        const key = cleanName + (window.isReviewMode ? "_review" : "_study");
                        if(window.isReviewMode) { tryDB[cleanName] = (tryDB[cleanName] || 0) + 1; localStorage.setItem('woojin_try_v1', JSON.stringify(tryDB)); }
                        doneDB[key] = dateStr; localStorage.setItem('woojin_done_v1', JSON.stringify(doneDB));
                        dailyLimitDB.counts[key] = (dailyLimitDB.counts[key] || 0) + 1; localStorage.setItem('woojin_daily_limit_v3', JSON.stringify(dailyLimitDB));
                        if(state.isPerfect) {
                            if(window.isReviewMode) {
                                perfectDB[key] = (perfectDB[key] || 0) + 1;
                                if(perfectDB[key] >= 5) { state.coins += 200; animateCoinIncrease(200); showToast(`ğŸ”¥ ì—­ì‹œ ìš°ì§„ì´ì•¼!\n[${cleanName}] 5íšŒ ë§Œì  ë‹¬ì„±!\në³´ë„ˆìŠ¤ 200ì½”ì¸ íšë“! ğŸª™`, "success"); delete wrongDB[cleanName]; delete tryDB[cleanName]; perfectDB[key] = 0; localStorage.setItem('woojin_wrong_v3', JSON.stringify(wrongDB)); localStorage.setItem('woojin_try_v1', JSON.stringify(tryDB)); }
                                else { showToast(`ğŸ’¯ [${cleanName}] ë°±ì  ë§Œì !\n(ë§Œì  ëˆ„ì : ${perfectDB[key]}/5íšŒ)\nì¡°ê¸ˆë§Œ ë” í•˜ë©´ ë³´ë„ˆìŠ¤ ì½”ì¸ì„ ì–»ì„ ìˆ˜ ìˆì–´!`, "success"); }
                            } else { state.coins += 100; animateCoinIncrease(100); showToast(`ğŸ’¯ ìš°ì§„ì´ ìµœê³ ! ë§Œì  ì„±ê³µ!\nê³µë¶€ ì½”ì¸ 100ê°œ íšë“! ğŸª™`, "success"); }
                        } else { showToast(`ğŸ‘ [${cleanName}] ì™„ë£Œ!\nìš°ì§„ì•„, ë‹¤ìŒì—ëŠ” ë°±ì ì— ë„ì „í•´ë³¼ê¹Œ?`, "info"); }
                        localStorage.setItem('woojin_perfect_v1', JSON.stringify(perfectDB)); setTimeout(() => goToMain(), 2500);
                    }
                }
            } else { playSound('wrong'); t.el.classList.add('wrong-impact'); d.el.classList.add('wrong-impact'); state.isPerfect = false; if(!window.isReviewMode) { const cleanName = currentActiveTitle; if(!wrongDB[cleanName]) wrongDB[cleanName] = []; if(!wrongDB[cleanName].some(w => w.t === t.item.t)) wrongDB[cleanName].push(t.item); if(!wrongDB[cleanName].some(w => w.t === d.item.t)) wrongDB[cleanName].push(d.item); localStorage.setItem('woojin_wrong_v3', JSON.stringify(wrongDB)); } setTimeout(() => { t.el.classList.remove('selected', 'wrong-impact'); d.el.classList.remove('selected', 'wrong-impact'); state.selectedTerm = state.selectedDef = null; }, 400); }
        }
    }
    function goToMain() { document.getElementById('mainPage').style.display = 'block'; document.getElementById('gamePage').style.display = 'none'; document.getElementById('topHomeBtn').style.visibility = 'hidden'; renderMenu(); window.scrollTo(0, 0); }
    function closeResetPopup() { document.getElementById('resetPopup').classList.remove('show'); }
    fetchSheetData();
</script>
</body>
</html>