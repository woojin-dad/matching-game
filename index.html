<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ìš°ì§„ì´ì˜ ìŠ¤ë§ˆíŠ¸ ë§¤ì¹­ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { background: #FEE500; font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; overflow-y: auto; }
        .container { width: 96%; max-width: 700px; background: white; padding: 12px; border-radius: 24px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); position: relative; display: flex; flex-direction: column; min-height: 100vh; margin: 10px 0 180px 0; height: auto; }
        #statusBar { position: sticky; top: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f9fafb; padding: 8px 12px; border-radius: 15px; flex-shrink: 0; height: 54px; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-left { display: flex; align-items: center; gap: 6px; }
        .coin-box { font-weight: 900; color: #3C1E1E; font-size: 1rem; display: flex; align-items: center; gap: 3px; }
        .music-toggle-btn { background: #E5E7EB; border: none; padding: 4px 10px; border-radius: 50px; cursor: pointer; font-size: 0.85rem; box-shadow: 0 2px 0 #9CA3AF; }
        .home-btn { position: absolute; left: 50%; transform: translateX(-50%); background: #3C1E1E; color: white; padding: 6px 18px; border-radius: 50px; font-size: 0.85rem; font-weight: bold; cursor: pointer; box-shadow: 0 3px 0 #000; }
        .status-right { display: flex; align-items: center; gap: 5px; }
        .gauge-bg { width: 90px; height: 16px; background: #e5e7eb; border-radius: 10px; overflow: hidden; border: 1px solid #d1d5db; } 
        #gaugeFill { height: 100%; width: 0%; background: linear-gradient(90deg, #4ADE80, #16A34A); transition: width 0.4s ease-out; }
        .reward-box { font-weight: 900; color: #3C1E1E; font-size: 1.1rem; }
        #mainPage { flex: 1; padding: 10px 5px; }
        .main-title { font-size: 2.2rem; font-weight: 900; color: #3C1E1E; text-shadow: 1px 1px 0 #fff; letter-spacing: -0.05em; cursor: pointer; -webkit-user-select: none; user-select: none; }
        .category-title { font-size: 1.5rem; font-weight: 900; margin-bottom: 18px; margin-top: 20px; color: #374151; border-left: 6px solid; padding-left: 12px; }
        .mode-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding-bottom: 80px; }
        
        .mode-card { position: relative; background: #3C1E1E; color: #FEE500; aspect-ratio: 1 / 1.15; border-radius: 26px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; box-shadow: 0 8px 0 #1a0d0d; padding: 12px; text-align: center; -webkit-user-select: none; user-select: none; touch-action: manipulation; min-height: 220px; }
        .mode-card:active { transform: translateY(4px); box-shadow: 0 4px 0 #1a0d0d; }
        .mode-card.locked { background: #94a3b8 !important; box-shadow: 0 8px 0 #64748b !important; opacity: 0.8; }
        .mode-card .icon-area { font-size: 2.8rem; margin-bottom: 6px; line-height: 1; }
        .mode-card .title { font-size: 1.15rem; font-weight: 900; margin-top: 4px; line-height: 1.2; color: #FFFFFF; word-break: keep-all; }
        
        .info-badge { font-size: 1.0rem; font-weight: 900; background: rgba(0,0,0,0.3); padding: 3px 10px; border-radius: 12px; margin-top: 6px; width: 90%; }
        .item-count { color: #FEE500; }
        .perfect-badge { color: #FFD700; }
        .done-label { color: #4ADE80; }
        .limit-badge { color: #CBD5E1; font-size: 0.85rem; }

        .delete-btn { position: absolute; top: -8px; right: -8px; width: 28px; height: 28px; background: #EF4444; color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2.5px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); z-index: 10; }
        body.admin-mode .delete-btn { display: flex; }

        #resetPopup { position: fixed; top: 20px; right: -350px; width: 280px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); border: 3px solid #EF4444; padding: 20px; z-index: 2000; transition: right 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); text-align: center; }
        #resetPopup.show { right: 20px; }
        #resetPopup.success-mode { border-color: #4ADE80; }
        #resetPopup p { font-weight: 900; color: #3C1E1E; margin-bottom: 15px; font-size: 1rem; line-height: 1.4; white-space: pre-line; }
        .popup-btns { display: flex; gap: 8px; justify-content: center; }
        .popup-btns button { padding: 8px 18px; border-radius: 12px; font-weight: 900; font-size: 0.9rem; cursor: pointer; border: none; }
        .btn-confirm { background: #EF4444; color: white; }
        .btn-cancel { background: #E5E7EB; color: #4B5563; }

        #rewardModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 1000; text-align: center; border: 6px solid #4ADE80; width: 85%; max-width: 400px; animation: popUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        #gamePage { flex: 1; display: none; flex-direction: column; min-height: 100%; }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 5px; margin-bottom: 10px; }
        #gameTitle { font-size: 1.1rem; font-weight: 900; color: #3C1E1E; }
        #pageIndicator { font-size: 0.85rem; font-weight: 900; background: #3C1E1E; color: #FEE500; padding: 4px 14px; border-radius: 50px; }
        .card { padding: 4px 8px; border-radius: 12px; border: 2.5px solid #e5e7eb; text-align: center; cursor: pointer; font-weight: 900; background: white; display: flex; align-items: center; justify-content: center; height: clamp(40px, 7vh, 70px); width: 100%; box-shadow: 0 4px 0 #f3f4f6; transition: all 0.05s linear; line-height: 1.1; }
        .term-card { background: #3C1E1E; color: #FEE500; border-color: #3C1E1E; box-shadow: 0 4px 0 #1a0d0d; }
        #definitionsColumn .card { border-color: #d1d5db; color: #3C1E1E; box-shadow: 0 4px 0 #cbd5e1; }
        .selected { border-color: #FEE500 !important; z-index: 10; transform: translateY(-2px); box-shadow: 0 4px 0 #FEE500 !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        .wrong-impact { animation: shake 0.2s ease-in-out; border-color: #EF4444 !important; background: #FEF2F2 !important; box-shadow: 0 4px 0 #EF4444 !important; }
        .matched { pointer-events: none; border-color: #FACC15 !important; background: #FEF9C3 !important; opacity: 0.5; transition: all 0.1s; }
    </style>
</head>
<body>

<div id="resetPopup">
    <p id="popupText">ê¸°ë¡ì„ ì´ˆê¸°í™”í• ê¹Œìš”?</p>
    <div class="popup-btns" id="popupBtnArea">
        <button class="btn-confirm" id="btnOk">ì´ˆê¸°í™”</button>
        <button class="btn-cancel" onclick="closeResetPopup()">ì·¨ì†Œ</button>
    </div>
</div>

<div id="rewardModal">
    <h2 id="rewardTitle">ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰</h2>
    <p id="rewardModalText">ë‚´ìš©</p>
    <button id="rewardBtn" onclick="closeRewardModal()" style="background: #4ADE80; color: white; padding: 10px 40px; border-radius: 50px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 4px 0 #16A34A;">í™•ì¸</button>
</div>

<div class="container">
    <audio id="bgm" loop></audio>
    <div id="statusBar">
        <div class="status-left"><div class="coin-box">ğŸª™ <span id="coinCount">...</span></div><button id="topMusicBtn" class="music-toggle-btn" onclick="toggleBGM()"><span id="musicIcon">ğŸµ</span></button></div>
        <button id="topHomeBtn" onclick="goToMain()" class="home-btn" style="visibility: hidden;">ğŸ  í™ˆ</button>
        <div class="status-right"><span class="bolt-icon">âš¡</span><div class="gauge-bg"><div id="gaugeFill"></div></div><div class="reward-box">ğŸ <span id="giftCount">0</span></div></div>
    </div>
    
    <div id="mainPage">
        <h1 class="text-center my-6 flex items-center justify-center gap-4">
            <span class="main-title" onclick="triggerAdminMode()">ğŸ§© ìš°ì§„ì´ì˜ ë§¤ì¹­ ê²Œì„<span id="adminMark" style="display:none; font-size:1rem; vertical-align:middle;"> ğŸ› ï¸</span></span>
            <button onclick="location.reload()" class="text-2xl bg-gray-100 p-2 rounded-full active:bg-gray-300">ğŸ”„</button>
        </h1>
        <div class="category-container mb-8"><div class="category-title text-blue-600 border-blue-600">ğŸ”„ ë³µìŠµ</div><div id="reviewGrid" class="mode-grid"></div></div>
        <div class="category-container mb-8"><div class="category-title text-green-600 border-green-600">ğŸ“– í•™ìŠµ</div><div id="studyGrid" class="mode-grid"></div></div>
    </div>

    <div id="gamePage">
        <div class="game-header"><h2 id="gameTitle"></h2><div id="pageIndicator"></div></div>
        <div class="game-board-wrapper"><div class="grid grid-cols-2 gap-x-2 gap-y-3 w-full" id="gameGrid"><div id="termsColumn" class="flex flex-col gap-y-3"></div><div id="definitionsColumn" class="flex flex-col gap-y-3"></div></div></div>
    </div>
</div>

<script>
    const finalScriptUrl = "https://script.google.com/macros/s/AKfycbyWobZtNiP8eFtdxTzk9ZXCOfaIyEZKN_hlAsjMggj6OEM-PXbn7g_YG6y1EJhcWa0Fyg/exec";
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT3vqts3wY7dCnxbXq1pedePNTOH32_sNnxqAgqx4EIYtaTok3NU-HpwdYOaNIdWFvogYEd6JI1pst1/pub?output=csv";

    let state = { coins: 0, totalMatchedCount: 0, giftCount: 0, maxGauge: 500, selectedTerm: null, selectedDef: null, isPerfect: true };
    let gameData = [], currentIdx = null, currentPage = 0, allCurrentItems = [];
    
    let wrongDB = JSON.parse(localStorage.getItem('woojin_wrong_v3')) || {};
    let doneDB = JSON.parse(localStorage.getItem('woojin_done_v1')) || {};
    let perfectDB = JSON.parse(localStorage.getItem('woojin_perfect_v1')) || {};
    let dailyLimitDB = JSON.parse(localStorage.getItem('woojin_daily_limit_v1')) || { date: "", counts: {} };

    const todayStr = new Date().toLocaleDateString();
    if (dailyLimitDB.date !== todayStr) {
        dailyLimitDB = { date: todayStr, counts: {} };
        localStorage.setItem('woojin_daily_limit_v1', JSON.stringify(dailyLimitDB));
    }

    const bgm = document.getElementById('bgm');
    function toggleBGM() { if (bgm.paused) { bgm.src = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"; bgm.play(); document.getElementById('musicIcon').innerText = 'ğŸµ'; } else { bgm.pause(); document.getElementById('musicIcon').innerText = 'ğŸ”‡'; } }

    function triggerAdminMode() {
        if (!window.clickCount) window.clickCount = 0;
        window.clickCount++;
        clearTimeout(window.clickTimer);
        window.clickTimer = setTimeout(() => { window.clickCount = 0; }, 2000);
        if (window.clickCount === 5) {
            const isAdmin = document.body.classList.toggle('admin-mode');
            document.getElementById('adminMark').style.display = isAdmin ? 'inline' : 'none';
            showToast(isAdmin ? "ğŸ› ï¸ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”" : "ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ í•´ì œ", 'success');
            window.clickCount = 0;
        }
    }

    let autoCloseTimer = null;
    function showToast(message, type = 'info') {
        const popup = document.getElementById('resetPopup');
        const text = document.getElementById('popupText');
        const btnArea = document.getElementById('popupBtnArea');
        clearTimeout(autoCloseTimer);
        text.innerText = message;
        popup.classList.toggle('success-mode', type === 'success');
        if (type === 'success') {
            btnArea.style.display = 'none';
            popup.classList.add('show');
            autoCloseTimer = setTimeout(() => closeResetPopup(), 2500);
        } else {
            btnArea.style.display = 'flex';
            popup.classList.add('show');
        }
    }

    function openResetPopup(e, title, type) {
        e.stopPropagation();
        const modeName = (type === 'study' ? 'í•™ìŠµ' : 'ë³µìŠµ');
        showToast(`âš ï¸ ${title}ì˜\n${modeName} ê¸°ë¡ì„ ì§€ìš¸ê¹Œìš”?`, 'confirm');
        document.getElementById('btnOk').onclick = () => {
            const sKey = title + "_study";
            const rKey = title + "_review";
            if (type === 'study') { delete doneDB[sKey]; delete perfectDB[sKey]; }
            else { delete doneDB[rKey]; delete wrongDB[title]; delete perfectDB[rKey]; delete dailyLimitDB.counts[title]; }
            localStorage.setItem('woojin_done_v1', JSON.stringify(doneDB));
            localStorage.setItem('woojin_wrong_v3', JSON.stringify(wrongDB));
            localStorage.setItem('woojin_perfect_v1', JSON.stringify(perfectDB));
            localStorage.setItem('woojin_daily_limit_v1', JSON.stringify(dailyLimitDB));
            closeResetPopup(); renderMenu();
        };
    }
    function closeResetPopup() { document.getElementById('resetPopup').classList.remove('show'); }

    function parseCSV(text) { return text.split('\n').map(row => { let cols = []; let current = ""; let inQuotes = false; for (let i = 0; i < row.length; i++) { if (row[i] === '"') inQuotes = !inQuotes; else if (row[i] === ',' && !inQuotes) { cols.push(current); current = ""; } else current += row[i]; } cols.push(current); return cols; }); }
    
    async function syncFromCloud() { 
        try { 
            const response = await fetch(finalScriptUrl + "?callback=loadData"); 
            const text = await response.text();
            const data = JSON.parse(text.match(/loadData\((.*)\)/)[1]);
            state.coins = Number(data.coins) || 0; state.totalMatchedCount = Number(data.matched) || 0; 
            state.giftCount = Number(data.gifts) || 0; state.maxGauge = data.maxGauge || 500; updateUI(false); 
        } catch (e) {
            try {
                const res = await fetch(finalScriptUrl); const data = await res.json();
                state.coins = Number(data.coins) || 0; state.totalMatchedCount = Number(data.matched) || 0;
                state.giftCount = Number(data.gifts) || 0; state.maxGauge = data.maxGauge || 500; updateUI(false);
            } catch(e2) {}
        } 
    }
    
    async function syncToCloud() { 
        try { if (state.totalMatchedCount >= state.maxGauge) { state.giftCount += 1; state.coins += 1000; state.totalMatchedCount = 0; confetti(); 
            document.getElementById('rewardTitle').innerText = "ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‰";
            document.getElementById('rewardModalText').innerHTML = "ê²Œì´ì§€ë¥¼ ëª¨ë‘ ì±„ì› ì–´ìš”!<br>ğŸ ì„ ë¬¼ 1ê°œì™€<br>ğŸª™ 1,000ì½”ì¸ì„ íšë“!";
            document.getElementById('rewardModal').style.display = 'block'; } 
            await fetch(finalScriptUrl, { method: 'POST', body: JSON.stringify({ coins: state.coins, matched: state.totalMatchedCount, gifts: state.giftCount }) }); 
        } catch (e) { console.error(e); } 
    }

    function updateUI(send = true) { 
        document.getElementById('coinCount').innerText = state.coins.toLocaleString(); 
        document.getElementById('giftCount').innerText = state.giftCount; 
        const progress = (state.totalMatchedCount / state.maxGauge) * 100; 
        document.getElementById('gaugeFill').style.width = Math.min(progress, 100) + '%'; 
        if(send) syncToCloud(); 
    }

    function applySmartFontSize(el) { let size = 1.35; el.style.fontSize = size + "rem"; while (el.scrollHeight > el.clientHeight && size > 0.6) { size -= 0.05; el.style.fontSize = size + "rem"; } }
    async function fetchSheetData() { await syncFromCloud(); try { const res = await fetch(`${sheetUrl}&cb=${Date.now()}`); const text = await res.text(); const rows = parseCSV(text).slice(1); gameData = rows.map(row => { if (!row[0] || !row[2]) return null; const rawData = row[2].trim().endsWith(';') ? row[2] : row[2] + ';'; const items = rawData.split(';').map(i => { const p = i.split('/'); return p.length >= 2 ? { t: p[0].trim(), d: p[1].trim() } : null; }).filter(i => i); return items.length > 0 ? { title: row[0].trim(), icon: (row[1] || "ğŸ“š").trim(), items } : null; }).filter(d => d); renderMenu(); } catch (e) { alert("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨!"); } }

    function renderMenu() {
        const study = document.getElementById('studyGrid'), review = document.getElementById('reviewGrid');
        study.innerHTML = ''; review.innerHTML = '';
        gameData.forEach((mode, idx) => {
            const sKey = mode.title + "_study", sDate = doneDB[sKey];
            const d = document.createElement('div'); d.className = 'mode-card';
            d.innerHTML = `<div class="delete-btn" onclick="openResetPopup(event, '${mode.title}', 'study')">Ã—</div>
                           <div class="icon-area">${mode.icon}</div><div class="title">${mode.title}</div>
                           <div class="info-badge item-count">${mode.items.length}ìŒ</div>
                           ${sDate ? `<div class="info-badge done-label">v ${sDate}</div>` : ''}`;
            d.onclick = () => { state.isPerfect = true; if(bgm.paused) toggleBGM(); startGame(mode.title, mode.items, false); };
            study.appendChild(d);

            const rKey = mode.title + "_review", rItems = wrongDB[mode.title] || [], rDate = doneDB[rKey], rPerfectCount = perfectDB[rKey] || 0;
            const rCount = dailyLimitDB.counts[mode.title] || 0;
            const isLocked = rCount >= 3;

            const r = document.createElement('div'); 
            r.className = 'mode-card' + (isLocked ? ' locked' : ''); 
            r.style.background = "#475569";
            r.innerHTML = `<div class="delete-btn" onclick="openResetPopup(event, '${mode.title}', 'review')">Ã—</div>
                           <div class="icon-area">${mode.icon}</div><div class="title">${mode.title}</div>
                           <div class="info-badge item-count">${rItems.length}ìŒ</div>
                           ${(rPerfectCount > 0 && rPerfectCount < 5) ? `<div class="info-badge perfect-badge">ğŸ’¯ ${rPerfectCount}íšŒ</div>` : ''}
                           <div class="info-badge limit-badge">${isLocked ? 'âœ… ë³µìŠµì™„ë£Œ' : 'ğŸ”„ ì˜¤ëŠ˜ ' + rCount + '/3'}</div>`;
            r.onclick = () => { 
                if (isLocked) {
                    showToast("ì˜¤ëŠ˜ì€ ì¶©ë¶„íˆ ë³µìŠµí–ˆì–´ìš”!\në‚´ì¼ ë˜ ë§Œë‚˜ìš”. ğŸ˜Š", 'success');
                    return;
                }
                state.isPerfect = true; if(bgm.paused) toggleBGM();
                if(rItems.length > 0) startGame(mode.title, rItems, true); 
                else showToast("âœ¨ ì™„ë²½í•´ìš”!\në³µìŠµí•  ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤. ğŸ‘", 'success'); 
            };
            review.appendChild(r);
        });
    }

    function startGame(title, items, isReview) { window.isReviewMode = isReview; document.getElementById('mainPage').style.display = 'none'; document.getElementById('gamePage').style.display = 'flex'; document.getElementById('topHomeBtn').style.visibility = 'visible'; allCurrentItems = [...items].sort(() => Math.random() - 0.5); currentPage = 0; renderPage(title); window.scrollTo(0, 0); }
    function renderPage(title) { const totalPages = Math.ceil(allCurrentItems.length / 10); document.getElementById('gameTitle').innerText = (window.isReviewMode ? "ğŸ”„ " : "") + title; document.getElementById('pageIndicator').innerText = `${currentPage + 1} / ${totalPages}`; const pageItems = allCurrentItems.slice(currentPage * 10, (currentPage + 1) * 10); const tCol = document.getElementById('termsColumn'), dCol = document.getElementById('definitionsColumn'); tCol.innerHTML = ''; dCol.innerHTML = ''; [...pageItems].sort(() => Math.random() - 0.5).forEach(item => { const c = document.createElement('div'); c.className = 'card term-card'; c.innerText = item.t; tCol.appendChild(c); applySmartFontSize(c); c.onclick = () => selectCard(item, 'term', c); }); [...pageItems].sort(() => Math.random() - 0.5).forEach(item => { const c = document.createElement('div'); c.className = 'card'; c.innerText = item.d; dCol.appendChild(c); applySmartFontSize(c); c.onclick = () => selectCard(item, 'def', c); }); }

    function selectCard(item, type, el) {
        if(el.classList.contains('matched') || el.classList.contains('wrong-impact')) return;
        if(type === 'term') { document.querySelectorAll('#termsColumn .card').forEach(c => c.classList.remove('selected')); state.selectedTerm = { item, el }; }
        else { document.querySelectorAll('#definitionsColumn .card').forEach(c => c.classList.remove('selected')); state.selectedDef = { item, el }; }
        el.classList.add('selected');
        if(state.selectedTerm && state.selectedDef) {
            const t = state.selectedTerm, d = state.selectedDef;
            if(t.item.t === d.item.t) {
                t.el.className = 'card matched'; d.el.className = 'card matched';
                state.coins++; state.totalMatchedCount++; updateUI(); state.selectedTerm = state.selectedDef = null;
                const pc = allCurrentItems.slice(currentPage * 10, (currentPage + 1) * 10).length;
                if(document.querySelectorAll('.matched').length === (pc * 2)) {
                    if((currentPage + 1) * 10 < allCurrentItems.length) { currentPage++; setTimeout(() => renderPage(document.getElementById('gameTitle').innerText), 500); }
                    else {
                        const now = new Date(); const dateStr = `${String(now.getMonth() + 1).padStart(2, '0')}/${String(now.getDate()).padStart(2, '0')}`;
                        const title = document.getElementById('gameTitle').innerText.replace("ğŸ”„ ", "");
                        const key = title + (window.isReviewMode ? "_review" : "_study");
                        doneDB[key] = dateStr;

                        if (window.isReviewMode) {
                            dailyLimitDB.counts[title] = (dailyLimitDB.counts[title] || 0) + 1;
                            localStorage.setItem('woojin_daily_limit_v1', JSON.stringify(dailyLimitDB));
                        }

                        if(state.isPerfect) {
                            if(window.isReviewMode) {
                                perfectDB[key] = (perfectDB[key] || 0) + 1;
                                if(perfectDB[key] >= 5) {
                                    state.coins += 100; delete wrongDB[title]; delete perfectDB[key];
                                    confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 }, colors: ['#FFD700', '#FFA500'] });
                                    document.getElementById('rewardTitle').innerText = "ğŸ† 5íšŒ 100ì  ì„±ê³µ!";
                                    document.getElementById('rewardModalText').innerHTML = `<b>ğŸª™ 100ì½”ì¸ íšë“!</b><br><br>ë§ˆìŠ¤í„°ê°€ ë˜ì–´ ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ì™€ 100ì  í‘œì‹œê°€ ì •ë¦¬ë˜ì—ˆì–´ìš”!`;
                                    document.getElementById('rewardModal').style.display = 'block';
                                } else {
                                    showToast(`ğŸ’¯ ì™„ë²½í•´ìš”! ì´ ${perfectDB[key]}íšŒ ì„±ê³µ!\n5íšŒë¥¼ ì±„ìš°ë©´ 100ì½”ì¸ ë³´ë„ˆìŠ¤!`, "success");
                                    confetti();
                                }
                            } else {
                                state.coins += 100; showToast("ğŸ’¯ í•™ìŠµ ë§Œì ! ğŸª™ 100ì½”ì¸ íšë“!", "success"); confetti();
                            }
                        } else { confetti(); }
                        localStorage.setItem('woojin_done_v1', JSON.stringify(doneDB)); localStorage.setItem('woojin_perfect_v1', JSON.stringify(perfectDB));
                        setTimeout(() => { if(document.getElementById('rewardModal').style.display !== 'block') goToMain(); }, 2500);
                    }
                }
            } else {
                t.el.classList.add('wrong-impact'); d.el.classList.add('wrong-impact');
                state.isPerfect = false;
                if(!window.isReviewMode) {
                    const studyTitle = document.getElementById('gameTitle').innerText;
                    if(!wrongDB[studyTitle]) wrongDB[studyTitle] = [];
                    if(!wrongDB[studyTitle].some(w => w.t === t.item.t)) { wrongDB[studyTitle].push(t.item); localStorage.setItem('woojin_wrong_v3', JSON.stringify(wrongDB)); }
                }
                setTimeout(() => { t.el.classList.remove('selected', 'wrong-impact'); d.el.classList.remove('selected', 'wrong-impact'); state.selectedTerm = state.selectedDef = null; }, 400);
            }
        }
    }
    function goToMain() { document.getElementById('mainPage').style.display = 'block'; document.getElementById('gamePage').style.display = 'none'; document.getElementById('topHomeBtn').style.visibility = 'hidden'; renderMenu(); window.scrollTo(0, 0); }
    function closeRewardModal() { document.getElementById('rewardModal').style.display = 'none'; updateUI(true); goToMain(); }
    fetchSheetData();
</script>
</body>
</html>